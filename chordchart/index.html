<!DOCTYPE html>
<html>
<meta charset="utf-8">
  
<h1>Freight Movement Chord Chart</h1>
 
<aside>Mouseover to focus on freight movement to and from a particular state.</aside>
 
<body>

<script src="https://d3js.org/d3.v4.js"></script>

<div id="dropdown1">
    <p>Category</p>
    <select id="d3-dropdown-category">
        <option value='All'>All</option>
        <option value='Alcoholic beverages'>Alcoholic beverages</option>
        <option value='Animal feed'>Animal feed</option>
        <option value='Articles-base metal'>Articles-base metal</option>
        <option value='Base metals'>Base metals</option>
        <option value='Basic chemicals'>Basic chemicals</option>
        <option value='Building stone'>Building stone</option>
        <option value='Cereal grains'>Cereal grains</option>
        <option value='Chemical prods.'>Chemical prods.</option>
        <option value='Coal'>Coal</option>
        <option value='Coal-n.e.c.'>Coal-n.e.c.</option>
        <option value='Crude petroleum'>Crude petroleum</option>
        <option value='Electronics'>Electronics</option>
        <option value='Fertilizers'>Fertilizers</option>
        <option value='Fuel oils'>Fuel oils</option>
        <option value='Furniture'>Furniture</option>
        <option value='Gasoline'>Gasoline</option>
        <option value='Gravel'>Gravel</option>
        <option value='Live animals/fish'>Live animals/fish</option>
        <option value='Logs'>Logs</option>
        <option value='Machinery'>Machinery</option>
        <option value='Meat/seafood'>Meat/seafood</option>
        <option value='Metallic ores'>Metallic ores</option>
        <option value='Milled grain prods.'>Milled grain prods.</option>
        <option value='Misc. mfg. prods.'>Misc. mfg. prods.</option>
        <option value='Mixed freight'>Mixed freight</option>
        <option value='Motorized vehicles'>Motorized vehicles</option>
        <option value='Natural sands'>Natural sands</option>
        <option value='Newsprint/paper'>Newsprint/paper</option>
        <option value='Nonmetal min. prods.'>Nonmetal min. prods.</option>
        <option value='Nonmetallic minerals'>Nonmetallic minerals</option>
        <option value='Other ag prods.'>Other ag prods.</option>
        <option value='Other foodstuffs'>Other foodstuffs</option>
        <option value='Paper articles'>Paper articles</option>
        <option value='Pharmaceuticals'>Pharmaceuticals</option>
        <option value='Plastics/rubber'>Plastics/rubber</option>
        <option value='Precision instruments'>Precision instruments</option>
        <option value='Printed prods.'>Printed prods.</option>
        <option value='Textiles/leather'>Textiles/leather</option>
        <option value='Tobacco prods.'>Tobacco prods.</option>
        <option value='Transport equip.'>Transport equip.</option>
        <option value='Unknown'>Unknown</option>
        <option value='Waste/scrap'>Waste/scrap</option>
        <option value='Wood prods.'>Wood prods.</option>
    </select>
</div>
<div id="dropdown2">
    <select id="d3-dropdown-metric">
        <option value='million_dollars'>Value in Million Dollars</option>
        <option value='ktons'>Weight in Kilotons</option>
        <option value='ton_miles'>Work in Ton-Miles</option>
    </select>
</div>
<div id="dropdown3">
    <select id="d3-dropdown-year">
        <option value='2012'>2012</option>
        <option value='2013'>2013</option>
        <option value='2014'>2014</option>
        <option value='2015'>2015</option>
    </select>
</div>

<div id="dropdown4">
    <select id="d3-dropdown-region">
        <option value='International'> International</option>
        <option value='Africa'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Africa</option>
        <option value='Canada'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Canada</option>
        <option value='Eastern Asia'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Eastern Asia</option>
        <option value='Europe'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Europe</option>
        <option value='Mexico'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Mexico</option>
        <option value='Rest of Americas'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rest of Americas</option>
        <option value='SE Asia & Oceania'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SE Asia & Oceania</option>
        <option value='SW & Central Asia'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; SW & Central Asia</option>
        <option value='Midwest'> Midwest</option>
        <option value='Illinois'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Illinois</option>
        <option value='Indiana'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Indiana</option>
        <option value='Iowa'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Iowa</option>
        <option value='Kansas'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Kansas</option>
        <option value='Michigan'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Michigan</option>
        <option value='Minnesota'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Minnesota</option>
        <option value='Missouri'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Missouri</option>
        <option value='Nebraska'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Nebraska</option>
        <option value='North Dakota'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; North Dakota</option>
        <option value='Ohio'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Ohio</option>
        <option value='South Dakota'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; South Dakota</option>
        <option value='Wisconsin'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Wisconsin</option>
        <option value='Northeast'> Northeast</option>
        <option value='Connecticut'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Connecticut</option>
        <option value='Maine'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Maine</option>
        <option value='Massachusetts'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Massachusetts</option>
        <option value='New Hampshire'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; New Hampshire</option>
        <option value='New Jersey'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; New Jersey</option>
        <option value='New York'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; New York</option>
        <option value='Pennsylvania'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Pennsylvania</option>
        <option value='Rhode Island'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Rhode Island</option>
        <option value='Vermont'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Vermont</option>
        <option value='Southeast'> Southeast</option>
        <option value='Alabama'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Alabama</option>
        <option value='Arkansas'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Arkansas</option>
        <option value='Delaware'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Delaware</option>
        <option value='Florida'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Florida</option>
        <option value='Georgia'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Georgia</option>
        <option value='Kentucky'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Kentucky</option>
        <option value='Louisiana'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Louisiana</option>
        <option value='Maryland'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Maryland</option>
        <option value='Mississippi'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Mississippi</option>
        <option value='North Carolina'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; North Carolina</option>
        <option value='South Carolina'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; South Carolina</option>
        <option value='Tennessee'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Tennessee</option>
        <option value='Virginia'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Virginia</option>
        <option value='Washington DC'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Washington DC</option>
        <option value='West Virginia'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; West Virginia</option>
        <option value='Southwest'> Southwest</option>
        <option value='Arizona'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Arizona</option>
        <option value='New Mexico'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; New Mexico</option>
        <option value='Oklahoma'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Oklahoma</option>
        <option value='Texas'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Texas</option>
        <option value='West'> West</option>
        <option value='Alaska'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Alaska</option>
        <option value='California'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; California</option>
        <option value='Colorado'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Colorado</option>
        <option value='Hawaii'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Hawaii</option>
        <option value='Idaho'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Idaho</option>
        <option value='Montana'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Montana</option>
        <option value='Nevada'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Nevada</option>
        <option value='Oregon'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Oregon</option>
        <option value='Utah'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Utah</option>
        <option value='Washington'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Washington</option>
        <option value='Wyoming'> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Wyoming</option>
    </select>
</div>
<input id="slider" type="range" min="0" max="10000" step="1" value="0" onchange="document.getElementById('number').value = this.value">
<input id="number" type="number" min="0" max="10000" step="1" value="0" onchange="document.getElementById('slider').value = this.value">



<div id="button">
    <button onclick="select()">Run</button>
</div>



<script>

// Store data in object "imports" to be accessed later. 
var imports = [];
var lookup = [];
d3.csv("data/summed_data.csv", function(error, data){
  d3.csv("data/zero_data.csv", function(error, default_data){
    d3.csv("data/region_colors.csv", function(error, region_data){
      if (error) {
        console.log(error);
        return error;}
      var filtered_data = data.filter(function(d) { return d.orig_name != d.dest_name; });
      imports = d3.merge([filtered_data,default_data]);
      lookup = region_data
      // console.log(colors);
      console.log(imports);
      // console.log(default_data);
      // console.log(imports);
});});});

var margin = {top: 20, right: 20, bottom: 70, left: 40},
    width = 960 - margin.left - margin.right,
    height = 960 - margin.top - margin.bottom,
    outerRadius = 450,
    innerRadius = 450;

var svgChart = d3.select("body")
  .append("svg")
  .attr("width", width + margin.left + margin.right)
  .attr("height", height + margin.top + margin.bottom)
  .append("g");

function render(data, category, metricyear, region, metric_min ) {

  // console.log(metric)

  svgChart
    .select("g")
    .remove();

  var nest_data = d3.nest()
    .key(function(d) { return (d.orig_type + d.orig_name); }).sortKeys(d3.ascending)
    .key(function(d) { return (d.dest_type + d.dest_name); }).sortKeys(d3.ascending)
    .rollup(function(v) { return d3.sum(v, function(d) {
      return d[metricyear]; })})
    .entries(imports.filter(function(d){ 
      if (category == 'All') { return 1==1; } 
      else { return (d.category == category || d.category == 'Default')}
      ;}))

  console.log(nest_data)

  var matrix = nest_data.map(
  function(orig_name, row) {
    return orig_name.values.map(
      function(dest_name, col) { 

        if (Math.abs(dest_name.value + nest_data[col].values[row].value) > metric_min)
          { return Math.abs(dest_name.value + nest_data[col].values[row].value) }
        else 
          { return 0 };
        // return Math.abs(dest_name.value + nest_data[col].values[row].value)

      })})

  var color_matrix = nest_data.map(
  function(orig_name, row) {
    return orig_name.values.map(
      function(dest_name, col) { 
        return Math.sign(dest_name.value + -1*nest_data[col].values[row].value)
      })})

  console.log(matrix);
  console.log(color_matrix);

  //Initialize canvas and inner/outer radii of the chords
  var outerRadius = Math.min(width, height) * 0.5 - 65,
      innerRadius = outerRadius - 20;

  //Initialize chord diagram
  var chord = d3.chord()
      .padAngle(0.01)
      .sortSubgroups(d3.descending);

  //Set Arc Raddii
  var arc = d3.arc()
      .innerRadius(innerRadius)
      .outerRadius(outerRadius);

  //Set Ribbons
  var ribbon = d3.ribbon()
      .radius(innerRadius);

  //What does this do?
  var g = svgChart.append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")")
      .datum(chord(matrix));

  // d3.select("svg").text(category);

  //Defines each "group" in the chord diagram
  var group = g.append("g")
    .attr("class", "groups")
    .selectAll("g")
    .data(function(chords) { return chords.groups; })
    .enter()

  //Draw the radial arcs for each group
  group.append("path")
      .style("fill", function(d,i) { 
        return lookup[i].color;
      })
      .style("stroke", function(d,i) { return lookup[i].color; })
      .attr("d", arc)
      // .on("mouseover", function(d,i){
      //   console.log("arc mouseover");
      //   ribbons
      //     .style("fill", function(d){ return lookup[d.source.index].color;})
      //     .style("stroke", function(d){ return lookup[d.source.index].color;})
      //     .style("opacity", .6)
      //   ribbons
      //     .filter(function(d) { return d.source.index != i && d.target.index != i; })
      //     .transition()
      //     .style("fill", "#404040")
      //     .style("stroke", "#404040")
      //     .style("opacity", .05);
      //   ribbons
      //     .filter(function(d) {return d.target.index == i || d.source.index == i; })
      //     .style("opacity", .95);
      // })
      // .on("mouseout", function(d) {
      //   console.log("arc mouseout");
      //   ribbons
      //     .style("opacity", .6)
      //     .style("fill", function(d){ return lookup[d.source.index].color; })
      //     .style("stroke", function(d){ return lookup[d.source.index].color; })
      // ;})

  //Add labels to each group
  group.append("text")
        .attr("dy", ".35em") //width
        .attr("class", "name-label")
        .attr("transform", function(d,i) { //angle
          d.angle = (d.startAngle + d.endAngle) / 2; //calculate the average of the start angle and the end angle
          d.name = lookup[i].name; //assignment for the city
          return "rotate(" + (d.angle * 180 / Math.PI) + ")" +
            "translate(0," + -1.1 * (outerRadius + 10) + ")" +
            ((d.angle > Math.PI * 3 / 4 && d.angle < Math.PI * 5 / 4) ? "rotate(180)" : "");
        }) //to spin when the angle between 135 to 225 degrees
        .text(function(d) {
          if (d.value>0) {return d.name};
        });

  group.append("title").text(function(d) { 
    // console.log(d);
    var q = d3.formatPrefix(".2", 1e3);
    return "Total " + d.name + ":\n" + q(d.value); });

  //Draw the ribbons that go from group to group
  var ribbons =   g.append("g")
    .attr("class", "ribbons")
    .selectAll("path")
    .data(function(chords) { return chords; })
    .enter().append("path")
    .attr("d", ribbon)
    .style("fill", function(d){ return lookup[d.source.index].color;})
    .style("stroke", function(d){ return lookup[d.source.index].color;})
    .style("opacity", .05);

    ribbons
        .filter(function(row) {
          // console.log(row);
          // console.log(lookup[row.source.index]);
          return lookup[row.source.index].type == region 
              || lookup[row.target.index].type == region
              || lookup[row.source.index].name == region
              || lookup[row.target.index].name == region; })
        .style("fill", function(d){ return lookup[d.source.index].color;})
        .style("stroke", function(d){ return lookup[d.source.index].color;})
        .style("opacity", .95);

  // var ribbons =   g.append("g")
  //   .attr("class", "ribbons")
  //   .selectAll("path")
  //   .data(function(chords) { return chords; })
  //   .enter().append("path")
  //   .attr("d", ribbon)
  //   .style("fill", function(d){
  //     return lookup[d.source.index].color;})
  //   .style("stroke", function(d){
  //     return lookup[d.source.index].color;})
  //   .style("opacity", .6)
  //   .on("mouseover", function(d,i){
  //     console.log("ribbon mouseover");
  //     ribbons
  //       .style("fill", function(d){ return lookup[d.source.index].color;})
  //       .style("stroke", function(d){ return lookup[d.source.index].color;})
  //       .style("opacity", .6);
  //     ribbons
  //       .filter(function(row) {
  //           return row.source.index != d.source.index || row.target.index != d.target.index;})
  //       .style("fill", "#404040")
  //       .style("stroke", "#404040")
  //       .style("opacity", .05);
  //     ribbons
  //       .filter(function(row) {
  //           return row.source.index == d.source.index && row.target.index == d.target.index;})
  //       .style("opacity", .95);
  //     })
  //   .on("mouseout", function(d) {
  //     console.log("ribbon mouseout");
  //     ribbons
  //       .style("fill", function(d){ return lookup[d.source.index].color;})
  //       .style("stroke", function(d){ return lookup[d.source.index].color;})
  //       .style("opacity", .6)
  //     });

  ribbons.append("title").
      text(function(d){    
        var p = d3.format(".2%"), 
          q = d3.formatPrefix(".2", 1e3)
        return "Flow Info:\n" + lookup[d.source.index].name + " → " + lookup[d.target.index].name + ": " + q(d.target.value);});


  // //Define tick marks to run along each arc
  // var groupTick = group.selectAll(".group-tick")
  //   .data(function(d) {
  //     return groupTicks(d, 1e3); })
  //   .enter().append("g")
  //     .attr("class", "group-tick")
  //     .attr("transform", function(d) { return "rotate(" + (d.angle * 180 / Math.PI - 90) + ") translate(" + outerRadius + ",0)"; });

  // groupTick.append("line")
  //     .attr("x2", 6);

  // var formatValue = d3.formatPrefix(",.0", 1e3);

  // groupTick
  //   .filter(function(d) { return d.value % 5e3 === 0; })
  //   .append("text")
  //     .attr("x", 8)
  //     .attr("dy", ".35em")
  //     .attr("transform", function(d) { return d.angle > Math.PI ? "rotate(180) translate(-16)" : null; })
  //     .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
  //     .text(function(d) { return formatValue(d.value); });

  // // Returns an array of tick angles and values for a given group and step.
  // function groupTicks(d, step) {
  //   var k = (d.endAngle - d.startAngle) / d.value;
  //   return d3.range(0, d.value, step).map(function(value) {
  //     return {value: value, angle: value * k + d.startAngle};
  //   });
  // }


}

function select() {
  var category = d3.select( "#d3-dropdown-category" ).node().value
  var year = d3.select( "#d3-dropdown-year" ).node().value
  var metric = d3.select( "#d3-dropdown-metric" ).node().value
  var region = d3.select( "#d3-dropdown-region" ).node().value
  var metric_min = document.getElementById("number").value
  render( imports, category, metric+'_'+year, region, metric_min );
  console.log( category );
  console.log( metric+'_'+year );
  console.log( region )
  console.log( metric_min );
}

</script>
</body>
</html>
